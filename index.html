<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBARAN GCBD Phase 2 - Material Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Hide elements by default */
        #app-container, #login-container {
            display: none;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.show {
            display: flex; /* Show when 'show' class is added */
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Styles for Viewer Mode */
        .viewer-mode #add-material-btn,
        .viewer-mode .deliver-btn,
        .viewer-mode .issue-btn,
        .viewer-mode .edit-btn,
        .viewer-mode .delete-btn {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Login Page Container -->
    <div id="login-container" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl flex bg-white rounded-lg shadow-2xl overflow-hidden">
            <!-- Form Section -->
            <div class="w-full md:w-1/2 p-8 md:p-12">
                <div class="flex items-center mb-8">
                    <i data-lucide="box" class="h-8 w-8 text-blue-600 mr-2"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Inventory Tracker</h1>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Sign in to your account</h2>
                <p class="text-gray-500 mb-8">Welcome back! Please enter your details.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@inventory.com" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Sign In</button>
                </form>
            </div>
            <!-- Image Section -->
            <div class="hidden md:flex md:w-1/2 bg-gray-200 items-center justify-center p-12">
                <!-- IMPORTANT: Place your 'Steve Logo.png' file in the same folder as this HTML file. -->
                <img src="Steve Logo.png" alt="Company Logo" class="max-w-xs">
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">GBARAN GCBD Phase 2 - Material Tracker</h1>
                <div id="user-info" class="flex items-center space-x-4 text-sm">
                    <span id="user-email-display" class="text-gray-600 font-medium"></span>
                    <button id="sign-out-btn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 flex items-center space-x-2">
                        <i data-lucide="log-out" class="h-4 w-4"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Materials</p>
                        <p id="total-materials" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                        <i data-lucide="package"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Delivered</p>
                        <p id="total-delivered" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-green-100 text-green-600 p-3 rounded-full">
                        <i data-lucide="truck"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Issued</p>
                        <p id="total-issued" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full">
                        <i data-lucide="send"></i>
                    </div>
                </div>
            </div>

            <!-- Materials Table -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Material Inventory</h2>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="Search materials..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                            </div>
                        </div>
                        <button id="add-material-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <i data-lucide="plus" class="h-5 w-5"></i>
                            <span>Add Material</span>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PO Number</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivered</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="materials-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Add/Edit, Transaction) -->
    <div id="material-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 id="modal-title" class="text-2xl font-semibold">Add New Material</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="material-form" class="mt-5 space-y-4">
                <input type="hidden" id="material-id">
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required></textarea>
                </div>
                <div>
                    <label for="po-number" class="block text-sm font-medium text-gray-700">Purchase Order (PO) Number</label>
                    <input type="text" id="po-number" name="po-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="expected-qty" class="block text-sm font-medium text-gray-700">Expected Quantity</label>
                    <input type="number" id="expected-qty" name="expected-qty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required min="0">
                </div>
                <div class="flex justify-end pt-4">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Material</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="transaction-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3">
                 <h3 id="transaction-modal-title" class="text-2xl font-semibold"></h3>
                <button id="close-transaction-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="transaction-form" class="mt-5 space-y-4">
                <input type="hidden" id="transaction-material-id">
                <input type="hidden" id="transaction-type">
                <p id="transaction-material-desc" class="text-gray-800 font-medium"></p>
                <div>
                    <label for="transaction-qty" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="transaction-qty" name="transaction-qty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required min="1">
                </div>
                 <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="transaction-date" name="transaction-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="button" id="cancel-transaction-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, onSnapshot, doc, deleteDoc, query, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBMA6HduuXEM-OF953tDiaXG3a8zYXnlEk",
          authDomain: "inventory-tracker-e5b38.firebaseapp.com",
          projectId: "inventory-tracker-e5b38",
          storageBucket: "inventory-tracker-e5b38.appspot.com",
          messagingSenderId: "486657758459",
          appId: "1:486657758459:web:ba935a81c82aa5c8394c5e"
        };
        
        // --- USER AND ROLE MANAGEMENT ---
        const ADMIN_UID = "V8zL2oH8b1ZSmG1tdp11gmdtylM2";
        const VIEWER_UID = "Z35t7DqNx5OJktX39895BK2MS773";
        const authorizedUIDs = [ADMIN_UID, VIEWER_UID];
        let isViewer = false;

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let materialsUnsubscribe = null;

        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const signOutBtn = document.getElementById('sign-out-btn');

        const materialsTbody = document.getElementById('materials-tbody');
        const addMaterialBtn = document.getElementById('add-material-btn');
        const materialModal = document.getElementById('material-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const materialForm = document.getElementById('material-form');
        const modalTitle = document.getElementById('modal-title');
        const materialIdInput = document.getElementById('material-id');
        const searchInput = document.getElementById('search-input');
        
        const transactionModal = document.getElementById('transaction-modal');
        const transactionModalTitle = document.getElementById('transaction-modal-title');
        const closeTransactionModalBtn = document.getElementById('close-transaction-modal-btn');
        const cancelTransactionModalBtn = document.getElementById('cancel-transaction-modal-btn');
        const transactionForm = document.getElementById('transaction-form');
        const transactionMaterialIdInput = document.getElementById('transaction-material-id');
        const transactionTypeInput = document.getElementById('transaction-type');
        const transactionMaterialDesc = document.getElementById('transaction-material-desc');


        // --- AUTHENTICATION & UI MANAGEMENT ---
        onAuthStateChanged(auth, (user) => {
            if (user && authorizedUIDs.includes(user.uid)) {
                // An authorized user is logged in
                isViewer = user.uid === VIEWER_UID;
                
                document.getElementById('user-email-display').textContent = user.email;
                appContainer.classList.toggle('viewer-mode', isViewer);

                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';

                if (materialsUnsubscribe) materialsUnsubscribe();
                loadMaterials();

            } else {
                // No user or an unauthorized user is logged in
                if (user) { // If it's an unauthorized user, sign them out immediately
                    signOut(auth); 
                }
                isViewer = false;
                appContainer.classList.remove('viewer-mode');
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                if (materialsUnsubscribe) {
                    materialsUnsubscribe();
                    materialsUnsubscribe = null;
                }
                materialsTbody.innerHTML = '';
                updateDashboard([]);
            }
            lucide.createIcons();
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the app
            } catch (error) {
                console.error("Login failed:", error.code);
                loginError.textContent = "Error: Invalid email or password.";
                loginError.classList.remove('hidden');
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle showing the login screen
            } catch (error) {
                console.error("Sign out failed:", error);
                alert("Failed to sign out.");
            }
        });

        // --- DATA HANDLING ---
        function getMaterialsCollection() {
             // Both admin and viewer read data from the admin's data path.
             return collection(db, `materials/${ADMIN_UID}/items`);
        }

        function loadMaterials() {
            const q = query(getMaterialsCollection());
            materialsUnsubscribe = onSnapshot(q, (snapshot) => {
                const materials = [];
                snapshot.forEach(doc => {
                    materials.push({ id: doc.id, ...doc.data() });
                });
                renderMaterials(materials);
                updateDashboard(materials);
            }, (error) => {
                console.error("Error fetching materials:", error);
            });
        }
        
        function renderMaterials(materials) {
            materialsTbody.innerHTML = '';
             if (materials.length === 0) {
                materialsTbody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">No materials found. Click 'Add Material' to get started.</td></tr>`;
                return;
            }
            const searchTerm = searchInput.value.toLowerCase();
            const filteredMaterials = materials.filter(material => 
                material.description.toLowerCase().includes(searchTerm) ||
                (material.poNumber && material.poNumber.toLowerCase().includes(searchTerm))
            );

            filteredMaterials.forEach(material => {
                const delivered = material.delivered || 0;
                const issued = material.issued || 0;
                const balance = delivered - issued;

                let status, statusColor;
                if (delivered >= material.expectedQty) {
                    status = 'Fully Delivered';
                    statusColor = 'bg-green-100 text-green-800';
                } else if (delivered > 0) {
                    status = 'Partially Delivered';
                    statusColor = 'bg-yellow-100 text-yellow-800';
                } else {
                    status = 'Pending Delivery';
                    statusColor = 'bg-red-100 text-red-800';
                }

                const row = `
                    <tr id="material-${material.id}">
                        <td class="px-6 py-4 whitespace-pre-wrap max-w-sm">
                            <div class="text-sm font-medium text-gray-900">${material.description}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${material.poNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${material.expectedQty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${delivered}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-semibold">${issued}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${balance}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button class="deliver-btn text-green-600 hover:text-green-900" data-id="${material.id}" data-desc="${material.description}">Deliver</button>
                                <button class="issue-btn text-yellow-600 hover:text-yellow-900" data-id="${material.id}" data-desc="${material.description}">Issue</button>
                                <button class="edit-btn text-blue-600 hover:text-blue-900" data-id="${material.id}"><i data-lucide="edit" class="h-4 w-4"></i></button>
                                <button class="delete-btn text-red-600 hover:text-red-900" data-id="${material.id}"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
                materialsTbody.innerHTML += row;
            });
            lucide.createIcons();
        }
        
        function updateDashboard(materials) {
            const totalMaterials = materials.length;
            const totalDelivered = materials.reduce((sum, m) => sum + (m.delivered || 0), 0);
            const totalIssued = materials.reduce((sum, m) => sum + (m.issued || 0), 0);

            document.getElementById('total-materials').textContent = totalMaterials;
            document.getElementById('total-delivered').textContent = totalDelivered;
            document.getElementById('total-issued').textContent = totalIssued;
        }

        // --- MODAL HANDLING & ACTION GUARDS ---
        function openModal(material = null) {
            if (isViewer) return;
            materialForm.reset();
            if (material) {
                modalTitle.textContent = 'Edit Material';
                materialIdInput.value = material.id;
                document.getElementById('description').value = material.description;
                document.getElementById('po-number').value = material.poNumber;
                document.getElementById('expected-qty').value = material.expectedQty;
            } else {
                modalTitle.textContent = 'Add New Material';
                materialIdInput.value = '';
            }
            materialModal.classList.add('show');
            lucide.createIcons();
        }

        function closeModal() {
            materialModal.classList.remove('show');
        }

        function openTransactionModal(type, materialId, description) {
            if (isViewer) return;
            transactionForm.reset();
            transactionModalTitle.textContent = type === 'deliver' ? 'Log Delivery' : 'Log Issuance';
            transactionMaterialIdInput.value = materialId;
            transactionTypeInput.value = type;
            transactionMaterialDesc.textContent = description;
            document.getElementById('transaction-date').value = new Date().toISOString().slice(0, 10);
            transactionModal.classList.add('show');
        }
        
        function closeTransactionModal() {
            transactionModal.classList.remove('show');
        }

        // --- EVENT LISTENERS ---
        addMaterialBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        
        closeTransactionModalBtn.addEventListener('click', closeTransactionModal);
        cancelTransactionModalBtn.addEventListener('click', closeTransactionModal);

        materialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isViewer) {
                alert("You do not have permission to perform this action.");
                return;
            }
            // ... (rest of the logic is the same)
        });
        
        transactionForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            if (isViewer) {
                alert("You do not have permission to perform this action.");
                return;
            }
            // ... (rest of the logic is the same)
        });

        materialsTbody.addEventListener('click', async (e) => {
            if (isViewer) return; // Top-level guard for all actions
            
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            
            if(target.classList.contains('deliver-btn')) {
                openTransactionModal('deliver', id, target.dataset.desc);
            } else if(target.classList.contains('issue-btn')) {
                openTransactionModal('issue', id, target.dataset.desc);
            } else if (target.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(getMaterialsCollection(), id));
                if (docSnap.exists()) {
                    openModal({ id: docSnap.id, ...docSnap.data() });
                }
            } else if (target.classList.contains('delete-btn')) {
                if (window.confirm('Are you sure you want to delete this material?')) {
                    try {
                        await deleteDoc(doc(getMaterialsCollection(), id));
                    } catch (error) {
                        console.error("Error deleting material: ", error);
                        alert("Failed to delete material.");
                    }
                }
            }
        });
        
        searchInput.addEventListener('input', () => {
             if (auth.currentUser) loadMaterials();
        });


        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
